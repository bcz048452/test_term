# Hybrid講座システム_BAE_認証基盤移行_新モジュールへの切り替え_OS設定手順書
-----------------------------------------------------------------------------------
## 作業要件
-----------------------------------------------------------------------------------
|#|項目|内容|
|:--|:--|:--|
|1|対象システム|Hybrid講座システム_BAE|
|2|対象ホスト（VM）|tbfr501v|
|3|作業日|2024/1/29-30|
|4|変更管理|-|

-----------------------------------------------------------------------------------
## 1. 事前作業
-----------------------------------------------------------------------------------
1. 作業開始連絡  
関係者に作業開始の連絡を行う

2. 動作確認
以下のページにアクセスできることを確認
- s01
  - https://bae-ut-staging.benesse.ne.jp


-------------------------------------------------------------------------
-----------------------------------------------------------------------------------
## 2. サーバログイン
-----------------------------------------------------------------------------------
1. サーバにログインする。
2. ログ取得開始
3. ログインホスト確認
```
uname -n
```

4. rootユーザに切替 
```
su -
```

5. 切替確認
```
id
```

6. システムログ確認
```
cat /var/log/messages | egrep -i "error|warn|crit|fail|fatal|panic|alert|alarm|emerg"
```

-----------------------------------------------------------------------------------
## 3. セマフォ削除ジョブ無効化
-----------------------------------------------------------------------------------
1. ジョブ無効化  
SystemWalkerにログインし以下のジョブを無効化する
- 対象サーバ：tbfr501v
- プロジェクト：root
- ジョブネット名：
  - セマフォ削除
  - ~~セマフォ数集計~~　※セマフォ利用確認の為無効化しない

-----------------------------------------------------------------------------------
## 4. ログ削除設定戻し
-----------------------------------------------------------------------------------
1. ディレクトリ移動
```
cd /opt/scripts/automation/conf/ && pwd; ls -l
```

2. ファイルリネーム
```
mv automation.list automation.list_kirimodoshi.$(date +%Y%m%d) && ls -l
```

3. バックアップから戻す
```
mv automation.list.20231025 automation.list && ls -l
```

4. 差分確認  
★semファイルの削除のみ差分として出ていることを確認
```
diff automation.list automation.list_kirimodoshi.$(date +%Y%m%d)
```

5. テスト実行&設定反映  
★エラーが出力されないことを確認する
```
/opt/scripts/automation/bin/automation.sh -t /opt/scripts/automation/conf/automation.list
```

-----------------------------------------------------------------------------------
## 5. semカーネルパラメータ変更戻し
-----------------------------------------------------------------------------------
1. 変更前確認  
★2列目が「32768」であることを確認する。  
★4列目が「32768」であることを確認する。
```
sysctl kernel.sem
```

2. ファイルリネーム  
★ファイルが存在すること
```
ll /etc/sysctl.conf*
```  
★リネームされたこと
```
mv /etc/sysctl.conf /etc/sysctl.conf_kirimodoshi.$(date +%Y%m%d) && ls -l /etc/sysctl.conf*
```

3. バックアップから戻す
```
mv /etc/sysctl.conf.20231025 /etc/sysctl.conf && ls -l /etc/sysctl.conf*
```

4. 差分確認  
★変更箇所のみ差分出力されていることを確認
```
diff /etc/sysctl.conf /etc/sysctl.conf_kirimodoshi.$(date +%Y%m%d)
```

5. 設定反映
```
sysctl -p
```

1. 変更後確認  
★2列目が「32002」であることを確認する。  
★4列目が「1024」であることを確認する。
```
sysctl kernel.sem
```

-----------------------------------------------------------------------------------
## 99. 事後作業
-----------------------------------------------------------------------------------
1. システムログ確認
```
cat /var/log/messages | egrep -i "error|warn|crit|fail|fatal|panic|alert|alarm|emerg"
```

2. 動作確認
以下のページにアクセスできることを確認
- s01
  - https://bae-ut-staging.benesse.ne.jp


3. 作業終了連絡  
関係者に作業終了の連絡を行う