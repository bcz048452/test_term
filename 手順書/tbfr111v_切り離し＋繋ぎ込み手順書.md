# tbfr111v_切り離し＋繋ぎ込み手順書
-----------------------------------------------------------------------------------
## 作業要件
-----------------------------------------------------------------------------------
|#|項目|内容|
|:--|:--|:--|
|1|対象システム|BAE|
|2|対象ホスト|tbfr111v,tbfr191v|
|3|作業日|2024/2/7|
|4|変更管理|-|

-----------------------------------------------------------------------------------
## 1. 事前作業
-----------------------------------------------------------------------------------
1. 作業開始連絡<br>
   関係者に作業開始連絡を行う

2. 動作確認<br>
   以下のページにアクセスできることを確認
   - BAE(s01)
   - https://bae-staging.benesse.ne.jp

-----------------------------------------------------------------------------------
## 2. サーバログイン
-----------------------------------------------------------------------------------
1. サーバにログインする

2. ログ取得開始

3. ログインホスト確認
   ```
   uname -n
   ```

4. rootユーザに切替
   ```
   su -
   ```

5. 切替確認
   ```
   id
   ```

6. システムログ確認
   ```
   cat /var/log/messages | egrep -i "error|warn|crit|fail|fatal|panic|alert|alarm|emerg"
   ```

7. tbfr111vアクセスログ確認<br>
   別タブでtbfr111vにログインし、アクセスログが流れる状態にしておく
   ```
   tail -f /var/log/s01/apache/ssl_logs/s01_81_ssl_access_log.`date '+%Y%m%d'` | awk '{print $4,$5,$1,$6,$7,$9,$11}'
   ```

8. tbfr191vアクセスログ確認<br>
   別タブでtbfr191vにログインし、アクセスログが流れる状態にしておく
   ```
   tail -f /var/log/s01/apache/ssl_logs/s01_81_ssl_access_log.`date '+%Y%m%d'` | awk '{print $4,$5,$1,$6,$7,$9,$11}'
   ```

-----------------------------------------------------------------------------------
## 3. 負荷分散切り離し
-----------------------------------------------------------------------------------
1. NetScaler接続<br>
   ★NodeがPrimaryであることを確認
   - http://192.168.58.20/menu/neo　※セカンダリ
   - http://192.168.58.21/menu/neo
  
2. 負荷分散状態確認<br>
   Traffic Management > Load Balancing > Servers を選択<br>
   Searchより"tbfr111vp1"を選択<br>
   ★State欄が「Enabled」であること　※Disabledの場合切り離し不要<br>
   ★IPAddrress/Domain欄が「172.22.130.81」であること

3. 負荷分散切り離し<br>
   tbfr111vp1を選択し、右クリック。<br>
   Disableを選択し切り離しを実施。<br>
   ★Disableであることを確認

4. アクセスログ確認<br>
   下記URLにアクセスを行い、アクセスログが流れることを確認する<br>
   ★tbfr111vのアクセスログが止まっていること<br>
   ★tbfr191vのアクセスログが流れ始めること
   FQDN:
    - bae-staging.benesse.ne.jp

5. メンテナンス表示動作確認<br>
   事業部担当の方に動作確認依頼を行う<br>
   ★Sorry表示が行われていること

-----------------------------------------------------------------------------------
## 4. 負荷分散繋ぎ込み
-----------------------------------------------------------------------------------
1. NetScaler接続<br>
   ★NodeがPrimaryであることを確認
   - http://192.168.58.20/menu/neo　※セカンダリ
   - http://192.168.58.21/menu/neo

2. 負荷分散状態確認<br>
   Traffic Management > Load Balancing > Servers を選択<br>
   Searchより"tbfr111vp1"を選択<br>
   ★State欄が「Disable」であること<br>
   ★IPAddrress/Domain欄が「172.22.130.81」であること

3. 負荷分散繋ぎ込み<br>
   tbfr111vp1を選択し、右クリック。<br>
   Enabledを選択し繋ぎ込みを実施。<br>
   ★Enabledであることを確認

4. アクセスログ確認<br>
   下記URLにアクセスを行い、アクセスログが流れることを確認する<br>
   ★tbfr111vのアクセスログが流れ始めること<br>
   ★tbfr191vのアクセスログが止まっていること
   FQDN:
    - bae-staging.benesse.ne.jp

5. サービス動作確認<br>
   事業部担当の方に動作確認依頼を行う<br>
   ★Sorry表示ではないこと

-----------------------------------------------------------------------------------
## 99. 事後作業
-----------------------------------------------------------------------------------
1. システムログ確認
   ```
   cat /var/log/messages | egrep -i "error|warn|crit|fail|fatal|panic|alert|alarm|emerg"
   ```

2. 動作確認<br>
   以下のページにアクセスできることを確認
   - BAE(s01)
   - https://bae-staging.benesse.ne.jp

3. 作業終了連絡<br>
   関係者に作業終了の連絡を行う
